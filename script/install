#!/bin/bash
# Script: /root/install (NEW-SSHPLUS)
# Descrição: Instalador secundário para configurar SSHPlus, incluindo SSH, Apache, módulos, e cron.
# Data: 08/05/2025
# Fonte: https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/refs/heads/main/script/install

# Definir armadilha para limpar arquivos temporários em caso de interrupção ou saída
lst1='/etc/SSHPlus/.tmp'
trap 'rm -f /tmp/passlogin /root/install $lst1/list >/dev/null 2>&1; [[ -d /etc/SSHPlus/.tmp && -z "$(ls -A /etc/SSHPlus/.tmp)" ]] && rmdir /etc/SSHPlus/.tmp >/dev/null 2>&1' EXIT INT TERM

# Obter versão e IP
_lvk=$(wget -qO- https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/versao)
IP=$(wget -qO- ipv4.icanhazip.com)
IP2=$(wget -qO- http://whatismyip.akamai.com/)
[[ "$IP" != "$IP2" ]] && ipdovps="$IP2" || ipdovps="$IP"
echo -e "$ipdovps" >/etc/IP

# Configurar fuso horário
echo -e "America/Sao_Paulo" >/etc/timezone
ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime >/dev/null 2>&1
dpkg-reconfigure --frontend noninteractive tzdata >/dev/null 2>&1

# Criar diretórios necessários
[[ ! -d /etc/SSHPlus ]] && mkdir /etc/SSHPlus
[[ ! -d /etc/SSHPlus/v2ray ]] && mkdir /etc/SSHPlus/v2ray
[[ ! -d /etc/SSHPlus/senha ]] && mkdir /etc/SSHPlus/senha
[[ ! -e /etc/SSHPlus/Exp ]] && touch /etc/SSHPlus/Exp
[[ ! -d /etc/SSHPlus/userteste ]] && mkdir /etc/SSHPlus/userteste
[[ ! -d /etc/SSHPlus/.tmp ]] && mkdir /etc/SSHPlus/.tmp
[[ ! -d /etc/bot ]] && mkdir /etc/bot
[[ ! -d /etc/bot/info-users ]] && mkdir /etc/bot/info-users
[[ ! -d /etc/bot/arquivos ]] && mkdir /etc/bot/arquivos
[[ ! -d /etc/bot/revenda ]] && mkdir /etc/bot/revenda
[[ ! -d /etc/bot/suspensos ]] && mkdir /etc/bot/suspensos
[[ ! -d /etc/rec ]] && mkdir /etc/rec
[[ ! -e /etc/bot/lista_ativos ]] && touch /etc/bot/lista_ativos
[[ ! -e /etc/bot/lista_suspensos ]] && touch /etc/bot/lista_suspensos

# Configurar Apache (mudar porta 80 para 81 se necessário)
netstat -nplt | grep -w 'apache2' | grep -w '80' && sed -i "s/Listen 80/Listen 81/g" /etc/apache2/ports.conf && service apache2 restart

# Configurar SSH (ativar porta 22 e autenticação por senha)
[[ "$(grep -o '#Port 22' /etc/ssh/sshd_config)" == "#Port 22" ]] && sed -i "s;#Port 22;Port 22;" /etc/ssh/sshd_config && service ssh restart
grep -v "^PasswordAuthentication" /etc/ssh/sshd_config >/tmp/passlogin && mv /tmp/passlogin /etc/ssh/sshd_config
echo "PasswordAuthentication yes" >>/etc/ssh/sshd_config
rm -f /tmp/passlogin >/dev/null 2>&1

# Definir diretórios
_dir1='/bin'
_dir2='/etc/SSHPlus'

# Limpar arquivos antigos de forma robusta
find $_dir2 -maxdepth 1 -name "ShellBot.sh" -o -name "cabecalho" -o -name "open.py" -o -name "proxy.py" -o -name "wsproxy.py" -type f -exec rm -f {} \; >/dev/null 2>&1

# Baixar e instalar módulos
_mdls=("addhost" "ajuda" "alterarlimite" "alterarsenha" "apache2menu" "checkers" "checkmanager" "utili" "multi" "check" "chuser" "limit" "rps_cpu" "attscript" "Autobackup" "backup_mail.sh" "badvpn" "banner" "bashtop" "bot" "botssh" "ddos" "blocksite" "blockt" "blockuser" "bot" "botssh" "cabecalho" "conexao" "criarteste" "criarusuario" "delhost" "delscript" "detalhes" "dns-netflix.sh" "droplimiter" "expcleaner" "fr" "infousers" "inst-botteste" "initcheck" "instsqd" "limiter" "mainproxy" "menu" "menub" "menub2" "menuudp" "mudardata" "mtuning" "multi" "onlineapp" "openvpn.sh" "open.py" "otimizar" "painelv2ray" "prissh" "prnet.sh" "proxydt" "proxy.py" "turboproxymanager.py" "turboproxy.py" "psiphon.sh" "reiniciarservicos" "reiniciarsistema" "remover" "rustyproxy" "security" "senharoot" "ShellBot.sh" "slowdns" "slow_dns" "speedtest" "sshmonitor" "suspenderusuario.sh" "swapmemory" "trafegototal" "trojan-go" "uexpired" "userbackup" "velocity" "verifatt" "verifbot" "v2raymanager" "v2ray" "webmin.sh" "websocket.sh" "wireguard.sh" "wsproxy.py" "pkill.sh")
for _arq in ${_mdls[@]}; do
    [[ -e $_dir1/$_arq ]] && rm -f $_dir1/$_arq >/dev/null 2>&1
    wget -c -P $_dir1 https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/$_arq
    chmod +x $_dir1/$_arq
done
mv $_dir1/cabecalho $_dir1/bot $_dir1/open.py $_dir1/proxy.py $_dir1/wsproxy.py $_dir2

# Configurar /etc/hosts
_arq_host="/etc/hosts"
_host[0]="d1n212ccp6ldpw.cloudfront.net"
_host[1]="dns.whatsapp.net"
_host[2]="portalrecarga.vivo.com.br/recarga"
_host[3]="navegue.vivo.com.br/controle/"
_host[4]="navegue.vivo.com.br/pre/"
_host[5]="www.whatsapp.net"
_host[6]="/SSHPLUS?"
for host in ${_host[@]}; do
    if [[ "$(grep -w "$host" $_arq_host | wc -l)" = "0" ]]; then
        sed -i "3i\127.0.0.1 $host" $_arq_host
    fi
done

# Configurar autostart
[[ ! -e /etc/autostart ]] && {
    echo '#!/bin/bash
clear
#INICIO AUTOMATICO' >/etc/autostart
    chmod +x /etc/autostart
} || {
    [[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) != '0' ]] && wget -qO- https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/ShellBot.sh
    for proc in $(ps x | grep 'dmS' | grep -v 'grep' | awk {'print $1'}); do
        screen -r -S "$proc" -X quit    
    done
    screen -wipe >/dev/null
    echo '#!/bin/bash
clear
#INICIO AUTOMATICO' >/etc/autostart
    chmod +x /etc/autostart
}

# Configurar cron
crontab -r >/dev/null 2>&1
(
    crontab -l 2>/dev/null
    echo "@daily /bin/verifatt"
    echo "@reboot /etc/autostart"
    echo "* * * * * /etc/autostart"
    echo "0 */6 * * * /bin/uexpired"
) | crontab -

# Salvar versão
echo "$_lvk" >/bin/versao && cat /bin/versao > /home/sshplus

# Instalar jq
wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Install/jq-linux64 >/dev/null 2>&1
chmod +x jq-linux64 && mv jq-linux64 $(which jq)

# Reiniciar serviços
service cron restart >/dev/null 2>&1
service ssh restart >/dev/null 2>&1
[[ -d /var/www/html/openvpn ]] && service apache2 restart >/dev/null 2>&1

# Limpar $lst1/list
[[ -f $lst1/list ]] && rm -f $lst1/list >/dev/null 2>&1

# Criar diretório sshplus
mkdir /opt/sshplus
echo > /opt/sshplus/sshplus

# Baixar arquivos adicionais
cd /etc/SSHPlus/ && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/WebSocket && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/pub.key && wget https://raw.githubusercontent.com/PhoenixxZ2023/PLUS/main/Modulos/priv.pem && chmod 777 WebSocket && cd $HOME
cd /etc/SSHPlus/ && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/mainproxy && chmod 777 mainproxy && cd $HOME
cd /etc/SSHPlus/ && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Install/security && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Install/pub.key && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Install/priv.pem && chmod 777 security && cd $HOME
cd /etc/SSHPlus/ && wget https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Install/proxydt && chmod 777 proxydt && cd $HOME

# Limpeza final de arquivos temporários
[[ -f /root/install ]] && rm -f /root/install >/dev/null 2>&1
[[ -d /etc/SSHPlus/.tmp && -z "$(ls -A /etc/SSHPlus/.tmp)" ]] && rmdir /etc/SSHPlus/.tmp >/dev/null 2>&1
