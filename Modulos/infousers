#!/bin/bash
clear

echo -e "\E[44;1;37m USUÁRIO        SENHA       LIMITE      VALIDADE \E[0m"
echo ""

[[ ! -e /bin/versao ]] && rm -rf /bin/menu

awk -F : '$3 > 900 { print $1 }' /etc/passwd | sort | grep -v "nobody" | grep -viE 'polkitd|system-' | while read users; do
    lim=$(grep -w "$users" "$HOME/usuarios.db" | awk '{print $2}' || echo "1")
    senha=$(cat /etc/SSHPlus/senha/"$users" 2>/dev/null || echo "Null")
    datauser=$(chage -l "$users" | grep -i 'co' | awk -F : '{print $2}' | xargs)
    if [ "$datauser" = "never" ]; then
        data="\033[1;33mNunca\033[0m"
    else
        dat="$(date -d "$datauser" '+%Y-%m-%d')"
        hoje="$(date +%Y-%m-%d)"
        if [ "$(date -d "$hoje" +%s)" -ge "$(date -d "$dat" +%s)" ]; then
            data="\033[1;31mVenceu\033[0m"
        else
            dias_restantes=$(( ( $(date -d "$dat" +%s) - $(date +%s) ) / 86400 ))
            data="$dias_restantes \033[1;37mDias\033[0m"
        fi
    fi
    Usuario=$(printf ' %-15s' "$users")
    Senha=$(printf '%-13s' "$senha")
    Limite=$(printf '%-10s' "$lim")
    Data=$(printf '%-1s' "$data")
    echo -e "\033[1;33m$Usuario \033[1;37m$Senha \033[1;37m$Limite \033[1;32m$Data\033[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
done

_tuser=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
_ons=0
_onop=0
_ondrp=0
_onv2ray=0
SSH_PORTS=$(grep -E "^Port" /etc/ssh/sshd_config | awk '{print $2}' | tr '\n' ' ')
for port in $SSH_PORTS; do
    count=$(netstat -t | grep :$port | grep ESTABLISHED | wc -l 2>/dev/null || echo "0")
    _ons=$(( _ons + count ))
done
OPENVPN_PORTS=$(grep -E "^port" /etc/openvpn/*.conf | awk '{print $2}' | tr '\n' ' ')
for port in $OPENVPN_PORTS; do
    count=$(netstat -t | grep :$port | grep ESTABLISHED | wc -l 2>/dev/null || echo "0")
    _onop=$(( _onop + count ))
done
DROPBEAR_PORTS=$(ps aux | grep dropbear | grep -oP '\-p\s+\K[\d\s]+' | tr '\n' ' ')
for port in $DROPBEAR_PORTS; do
    count=$(netstat -t | grep :$port | grep ESTABLISHED | wc -l 2>/dev/null || echo "0")
    _ondrp=$(( _ondrp + count ))
done
V2RAY_PORTS=$(grep -E '"port":' /etc/v2ray/config.json | awk '{print $2}' | tr -d ',"' | tr '\n' ' ')
for port in $V2RAY_PORTS; do
    count=$(netstat -t | grep :$port | grep ESTABLISHED | wc -l 2>/dev/null || echo "0")
    _onv2ray=$(( _onv2ray + count ))
done
_onli=$(( $_ons + $_onop + $_ondrp + $_onv2ray ))
_expuser=$(cat /etc/SSHPlus/Exp 2>/dev/null || echo "0")

if [ -f "$HOME/valor" ]; then
    valor_sum=$(awk '{SUM += $1} END {print SUM}' "$HOME/valor")
else
    valor_sum="0"
fi

echo -e "\033[1;33m• \033[1;36mTOTAL USUARIOS\033[1;37m $_tuser \033[1;33m• \033[1;32mONLINES\033[1;37m: $_onli \033[1;33m• \033[1;31mVENCIDOS\033[1;37m: $_expuser"

echo -e "\E[44;1;37m USUÁRIO V2RAY         UUID         | USUÁRIO | VALIDADE \E[0m"
echo ""

if [ -d /etc/SSHPlus/v2ray ]; then
    vt=0
    for file in /etc/SSHPlus/RegV2ray /etc/SSHPlus/v2ray/RegV2ray-*; do
        if [ -f "$file" ]; then
            while IFS='|' read -r uuid user date || IFS=' ' read -r user uuid date; do
                if [ -n "$user" ] && [ -n "$uuid" ] && [ -n "$date" ]; then
                    VPSsec=$(date +%s)
                    DataSec=$(date +%s --date="$date")
                    if [ "$VPSsec" -gt "$DataSec" ]; then
                        validade="\033[1;31mVenceu\033[0m"
                    else
                        dias_restantes=$(( ( $DataSec - $VPSsec ) / 86400 ))
                        validade="$dias_restantes \033[1;37mDias\033[0m"
                    fi
                    Usuario=$(printf ' %-15s' "$user")
                    UUID=$(printf '%-36s' "$uuid")
                    Validade=$(printf '%-1s' "$validade")
                    echo -e "\033[1;33m$Usuario \033[1;37m$UUID \033[1;32m$Validade\033[0m"
                    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
                    vt=$(( vt + 1 ))
                fi
            done < "$file"
        fi
    done
    [ $vt -eq 0 ] && echo "Nenhum usuário V2Ray encontrado."
else
    echo "Diretório /etc/SSHPlus/v2ray não encontrado."
    vt=0
fi

echo ""
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;33m• \033[1;36mTOTAL USUARIOS\033[1;37m $vt \033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
