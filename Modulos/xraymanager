#!/bin/bash
#====================================================
#	@TURBONET2023
#	Gerenciador XRay, idêntico ao v2raymanager.sh
#====================================================

# Cores para mensagens
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
SCOLOR='\033[0m'
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'

# Mensagens de erro
msg01='USUÁRIO NULO'
msg02='NOME MUITO CURTO (MÍN: 2 CARACTERES)'
msg03='NOME MUITO LONGO (MÁX: 5 CARACTERES)'
msg07='DURAÇÃO NULA'
msg08='DURAÇÃO INVÁLIDA, USE NÚMEROS'
msg09='DURAÇÃO MÁXIMA DE UM ANO'
msg14='USUÁRIO JÁ EXISTE'
msg15='(APENAS NÚMEROS) GB = MÍN: 1GB MÁX: 1000GB'
msg16='(APENAS NÚMEROS)'
msg17='(SEM INFORMAÇÃO - PARA CANCELAR PRESSIONE CTRL + C)'

# Função para mensagens de erro
err_fun() {
    case $1 in
        1) msg -verm "${msg01}" ;;
        2) msg -verm "${msg02}" ;;
        3) msg -verm "${msg03}" ;;
        7) msg -verm "${msg07}" ;;
        8) msg -verm "${msg08}" ;;
        9) msg -verm "${msg09}" ;;
        14) msg -verm "${msg14}" ;;
        15) msg -verm "${msg15}" ;;
        16) msg -verm "${msg16}" ;;
        17) msg -verm "${msg17}" ;;
    esac
    sleep 2s
    tput cuu1 && tput dl1 && tput cuu1 && tput dl1
}

# Variável para modo XRay
KEY="xray"
CONFIG_PATH="/etc/xray"
LOG_PATH="/var/log/xray"
REG_PATH="/etc/SSHPlus/RegXray"
BACKUP_PATH="/etc/SSHPlus/xray"

# Função para exibir mensagens coloridas
msg() {
    case $1 in
        -verm) echo -e "${RED}${2}${SCOLOR}" ;;
        -azu) echo -e "${BLUE}${2}${SCOLOR}" ;;
        -verd) echo -e "${GREEN}${2}${SCOLOR}" ;;
        -ama) echo -e "${YELLOW}${2}${SCOLOR}" ;;
        *) echo -e "${2}" ;;
    esac
}

# Função de seleção de menu
selection_fun() {
    local selection="null"
    local range
    for ((i=0; i<=$1; i++)); do range[$i]="$i "; done
    while [[ ! $(echo ${range[*]} | grep -w "$selection") ]]; do
        echo -ne "\033[1;37m ► Selecione uma Opção: " >&2
        read selection
        tput cuu1 >&2 && tput dl1 >&2
    done
    echo $selection
}

# Verificar dependências
check_dependencies() {
    if ! command -v ${KEY} >/dev/null 2>&1; then
        echo -e "${RED}Erro: ${KEY} não está instalado ou o comando não está disponível.${SCOLOR}"
        echo -e "${YELLOW}Por favor, instale o ${KEY} usando o script de instalação.${SCOLOR}"
        exit 1
    fi
    if [[ ! -d ${CONFIG_PATH} ]]; then
        echo -e "${RED}Erro: Diretório de configuração ${CONFIG_PATH} não existe.${SCOLOR}"
        exit 1
    fi
    if [[ ! -f ${CONFIG_PATH}/config.json ]]; then
        echo -e "${RED}Erro: Arquivo de configuração ${CONFIG_PATH}/config.json não existe.${SCOLOR}"
        exit 1
    fi
}

# Função para instalar XRay
install_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            INSTALANDO ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    bash <(curl -sL https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/xray)
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}Erro: Falha ao instalar ${KEY^^}.${SCOLOR}"
        exit 1
    fi
    echo -e "${GREEN}${KEY^^} INSTALADO COM SUCESSO ✅!${SCOLOR}"
    [[ ! -e ${REG_PATH} ]] && mkdir -p $(dirname ${REG_PATH}) && touch ${REG_PATH}
    sort ${REG_PATH} | uniq >${REG_PATH}tmp
    mv -f ${REG_PATH}tmp ${REG_PATH}
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para editar protocolo
protocol_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            EDITAR PROTOCOLO ${KEY^^}             \E[0m"
    echo -e "\033[1;37m• \033[1;33mESCOLHA A OPÇÃO 3 E COLOQUE SEU DOMÍNIO OU HOST. EX: T3MMA.COM\033[1;31m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ${KEY} stream
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para ativar/desativar TLS
tls_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            ATIVAR OU DESATIVAR TLS             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ${KEY} tls
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para editar porta
port_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            EDITAR PORTA ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ${KEY} port
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para estatísticas de consumo
stats_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            ESTATÍSTICAS DE CONSUMO             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ${KEY} stats
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para desinstalar XRay
uninstall_core() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            DESINSTALANDO ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    bash <(curl -sL https://raw.githubusercontent.com/PhoenixxZ2023/NEW-SSHPLUS/main/Modulos/xray) --remove >/dev/null 2>&1
    rm -rf ${REG_PATH} >/dev/null 2>&1
    rm -rf ${BACKUP_PATH} >/dev/null 2>&1
    echo -e "${GREEN}${KEY^^} REMOVIDO COM SUCESSO!${SCOLOR}"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para informações da conta
info_account() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            INFORMAÇÕES DA CONTA             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    ${KEY} info
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para adicionar usuário/UUID
add_user() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            ADICIONAR USUÁRIO | UUID ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    # Gerar UUID e e-mail aleatório
    UUID=$(uuidgen)
    USERMAIL=$(cat /dev/urandom | tr -dc '[:alnum:]' | head -c 10)
    
    # Solicitar nome do usuário
    while true; do
        echo -ne "\033[91m >> DIGITE UM USUÁRIO: \033[1;92m"
        read -p ": " nick
        nick="$(echo $nick | sed -e 's/[^a-z0-9 -]//ig')"
        [[ -z $nick ]] && err_fun 17 && continue
        [[ "${#nick}" -lt 2 ]] && err_fun 2 && continue
        [[ "${#nick}" -gt 5 ]] && err_fun 3 && continue
        [[ $(grep -w "$nick" ${REG_PATH} | cut -d '|' -f2) ]] && err_fun 14 && continue
        break
    done

    # Solicitar duração
    while true; do
        echo -ne "\033[91m >> DURAÇÃO DO UUID (DIAS): \033[1;92m" && read diasuser
        [[ -z "$diasuser" ]] && err_fun 17 && continue
        [[ "$diasuser" != +([0-9]) ]] && err_fun 8 && continue
        [[ "$diasuser" -gt 360 ]] && err_fun 9 && continue
        break
    done

    # Calcular data de expiração
    valid=$(date '+%C%y-%m-%d' -d "+$diasuser days")
    datexp=$(date "+%F" -d "+$diasuser days")

    # Adicionar usuário ao config.json (VLESS para XRay)
    sed -i "/\"clients\": \[/a\           \{" ${CONFIG_PATH}/config.json
    sed -i "/\"clients\": \[/a\           \"id\": \"$UUID\"," ${CONFIG_PATH}/config.json
    sed -i "/\"clients\": \[/a\           \"email\": \"$USERMAIL@gmail.com\"," ${CONFIG_PATH}/config.json
    sed -i "/\"clients\": \[/a\           \"level\": 1" ${CONFIG_PATH}/config.json
    sed -i "/\"clients\": \[/a\           \}," ${CONFIG_PATH}/config.json

    # Registrar usuário
    echo "  $UUID | $nick | $valid" >> ${REG_PATH}
    Fecha=$(date +%d-%m-%y-%R)
    mkdir -p ${BACKUP_PATH}
    cp ${REG_PATH} ${BACKUP_PATH}/RegXray-"$Fecha"

    # Reiniciar serviço
    systemctl restart ${KEY} >/dev/null 2>&1

    # Exibir informações
    echo -e "\033[91m >> UUID: \033[92m$UUID"
    echo -e "\033[91m >> EXPIRA EM: \033[92m$datexp"
    ${KEY} info > ${BACKUP_PATH}/confuuid.log
    lineP=$(sed -n "/${UUID}/=" ${BACKUP_PATH}/confuuid.log)
    numl1=4
    let suma=$lineP+$numl1
    sed -n ${suma}p ${BACKUP_PATH}/confuuid.log
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[92m           UUID ADICIONADO COM SUCESSO"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para remover usuário/UUID
remove_user() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            REMOVER USUÁRIO | UUID ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    invaliduuid() {
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[91m                    UUID INVÁLIDO \n"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
        fun_xraymanager
    }
    echo -e "\033[97m               USUÁRIOS REGISTRADOS"
    echo -e "\033[33m$(cat ${REG_PATH} | cut -d '|' -f2,1)"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -ne "\033[91m >> DIGITE UUID PARA REMOVER:\n \033[1;92m " && read uuidel
    [[ $(sed -n "/${uuidel}/=" ${CONFIG_PATH}/config.json | head -1) ]] || invaliduuid
    lineP=$(sed -n "/${uuidel}/=" ${CONFIG_PATH}/config.json)
    linePre=$(sed -n "/${uuidel}/=" ${REG_PATH})
    sed -i "${linePre}d" ${REG_PATH}
    numl1=2
    let resta=$lineP-$numl1
    for ((i=0; i<5; i++)); do
        sed -i "${resta}d" ${CONFIG_PATH}/config.json
    done
    systemctl restart ${KEY} >/dev/null 2>&1
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[92m           UUID REMOVIDO COM SUCESSO"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para mostrar usuários registrados
show_users() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            USUÁRIOS REGISTRADOS | UUID ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    VPSsec=$(date +%s)
    local HOST="${REG_PATH}"
    local RETURN="$(cat $HOST | cut -d'|' -f2)"
    local IDEUUID="$(cat $HOST | cut -d'|' -f1)"
    if [[ -z $RETURN ]]; then
        echo -e "----- NENHUM USUÁRIO REGISTRADO -----"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
        fun_xraymanager
    else
        i=1
        echo -e "\033[97m                 UUID                | USUÁRIO | EXPIRAÇÃO \033[93m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        while read hostreturn; do
            DateExp="$(cat ${REG_PATH} | grep -w "$hostreturn" | cut -d'|' -f3)"
            if [[ ! -z $DateExp ]]; then
                DataSec=$(date +%s --date="$DateExp")
                [[ "$VPSsec" -gt "$DataSec" ]] && EXPTIME="\033[91m[EXPIRADO]\033[97m" || EXPTIME="\033[92m[$(($(($DataSec - $VPSsec)) / 86400))]\033[97m Dias"
            else
                EXPTIME="\033[91m[ S/R ]"
            fi
            usris="$(cat ${REG_PATH} | grep -w "$hostreturn" | cut -d'|' -f2)"
            local contador_secuencial+="\033[93m$hostreturn \033[97m|\033[93m$usris\033[97m|\033[93m $EXPTIME \n"
            if [[ $i -gt 30 ]]; then
                echo -e "$contador_secuencial"
                unset contador_secuencial
                unset i
            fi
            let i++
        done <<<"$IDEUUID"
        [[ ! -z $contador_secuencial ]] && {
            linesss=$(cat ${REG_PATH} | wc -l)
            echo -e "$contador_secuencial \n Número de Registrados: $linesss"
        }
    fi
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para limitar consumo por porta
limit_port() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            LIMITAR MB POR PORTA | UUID ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

    # Verificar portas limitadas
    show_limited_ports() {
        VPSsec=$(date +%s)
        local HOST="${BACKUP_PATH}/lisportt.log"
        if [[ ! -f $HOST ]]; then
            echo -e "----- NENHUMA PORTA REGISTRADA -----"
            echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
            echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
            fun_xraymanager
        fi
        local RETURN="$(cat $HOST | cut -d'|' -f2)"
        local IDEUUID="$(cat $HOST | cut -d'|' -f1)"
        i=1
        while read hostreturn; do
            iptables -n -v -L > ${BACKUP_PATH}/data1.log
            statsss=$(cat ${BACKUP_PATH}/data1.log | grep -w "tcp spt:$hostreturn quota:" | cut -d' ' -f3,4,5)
            gblim=$(cat ${BACKUP_PATH}/lisportt.log | grep -w "$hostreturn" | cut -d'|' -f2)
            local contador_secuencial+="         \033[97mPORTA: \033[93m$hostreturn \033[97m|\033[93m$statsss \033[97m|\033[93m $gblim GB  \n"
            if [[ $i -gt 30 ]]; then
                echo -e "$contador_secuencial"
                unset contador_secuencial
                unset i
            fi
            let i++
        done <<<"$IDEUUID"
        [[ ! -z $contador_secuencial ]] && {
            linesss=$(cat ${BACKUP_PATH}/lisportt.log | wc -l)
            echo -e "$contador_secuencial \n Portas Limitadas: $linesss"
        }
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
        fun_xraymanager
    }

    # Limitar porta
    limit_port_data() {
        while true; do
            echo -ne "\033[91m >> DIGITE PORTA A LIMITAR: \033[1;92m" && read portbg
            [[ -z "$portbg" ]] && err_fun 17 && continue
            [[ "$portbg" != +([0-9]) ]] && err_fun 16 && continue
            [[ "$portbg" -gt 1000 ]] && err_fun 16 && continue
            break
        done
        while true; do
            echo -ne "\033[91m >> DIGITE QUANTIDADE DE GB: \033[1;92m" && read capgb
            [[ -z "$capgb" ]] && err_fun 17 && continue
            [[ "$capgb" != +([0-9]) ]] && err_fun 15 && continue
            [[ "$capgb" -gt 1000 ]] && err_fun 15 && continue
            break
        done
        uml1=1073741824
        gbuser="$capgb"
        let multiplicacion=$uml1*$gbuser
        sudo iptables -I OUTPUT -p tcp --sport $portbg -j DROP
        sudo iptables -I OUTPUT -p tcp --sport $portbg -m quota --quota $multiplicacion -j ACCEPT
        iptables-save > /etc/iptables/rules.v4
        echo -e " Porta Selecionada: $portbg | Quantidade de GB: $gbuser"
        mkdir -p ${BACKUP_PATH}
        echo " $portbg | $gbuser | $multiplicacion " >> ${BACKUP_PATH}/lisportt.log
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
        fun_xraymanager
    }

    # Restaurar dados da porta
    restore_port_data() {
        VPSsec=$(date +%s)
        local HOST="${BACKUP_PATH}/lisportt.log"
        if [[ ! -f $HOST ]]; then
            echo -e "----- NENHUMA PORTA REGISTRADA -----"
            echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
            echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
            fun_xraymanager
        fi
        local RETURN="$(cat $HOST | cut -d'|' -f2)"
        local IDEUUID="$(cat $HOST | cut -d'|' -f1)"
        i=1
        while read hostreturn; do
            iptables -n -v -L > ${BACKUP_PATH}/data1.log
            statsss=$(cat ${BACKUP_PATH}/data1.log | grep -w "tcp spt:$hostreturn quota:" | cut -d' ' -f3,4,5)
            gblim=$(cat ${BACKUP_PATH}/lisportt.log | grep -w "$hostreturn" | cut -d'|' -f2)
            local contador_secuencial+="         \033[97mPORTA: \033[93m$hostreturn \033[97m|\033[93m$statsss \033[97m|\033[93m $gblim GB  \n"
            if [[ $i -gt 30 ]]; then
                echo -e "$contador_secuencial"
                unset contador_secuencial
                unset i
            fi
            let i++
        done <<<"$IDEUUID"
        [[ ! -z $contador_secuencial ]] && {
            linesss=$(cat ${BACKUP_PATH}/lisportt.log | wc -l)
            echo -e "$contador_secuencial \n Portas Limitadas: $linesss"
        }
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        while true; do
            echo -ne "\033[91m >> DIGITE PORTA A LIMPAR: \033[1;92m" && read portbg
            [[ -z "$portbg" ]] && err_fun 17 && continue
            [[ "$portbg" != +([0-9]) ]] && err_fun 16 && continue
            [[ "$portbg" -gt 1000 ]] && err_fun 16 && continue
            break
        done
        invaliduuid() {
            echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
            echo -e "\033[91m                PORTA INVÁLIDA \n"
            echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
            echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
            fun_xraymanager
        }
        [[ $(sed -n "/${portbg}/=" ${BACKUP_PATH}/lisportt.log | head -1) ]] || invaliduuid
        gblim=$(cat ${BACKUP_PATH}/lisportt.log | grep -w "$portbg" | cut -d'|' -f3)
        sudo iptables -D OUTPUT -p tcp --sport $portbg -j DROP
        sudo iptables -D OUTPUT -p tcp --sport $portbg -m quota --quota $gblim -j ACCEPT
        iptables-save > /etc/iptables/rules.v4
        lineP=$(sed -n "/${portbg}/=" ${BACKUP_PATH}/lisportt.log)
        sed -i "${lineP}d" ${BACKUP_PATH}/lisportt.log
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
        fun_xraymanager
    }

    # Menu de limitação por porta
    echo -e "\033[1;37m\033[1;33m[1] > LIMITAR DADOS POR PORTA\033[1;31m"
    echo -e "\033[1;37m\033[1;33m[2] > RESTAURAR DADOS DA PORTA\033[1;31m"
    echo -e "\033[1;37m\033[1;33m[3] > VER DADOS CONSUMIDOS\033[1;31m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;32m [0] > \033[97m\033[1;41m VOLTAR \033[1;37m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    selection=$(selection_fun 3)
    case ${selection} in
        1) limit_port_data ;;
        2) restore_port_data ;;
        3) show_limited_ports ;;
        0) fun_xraymanager ;;
    esac
}

# Função para ativar/desativar limpador de expirados
clean_expired() {
    unset PIDGEN
    PIDGEN=$(ps aux | grep -v grep | grep "limxray")
    if [[ ! $PIDGEN ]]; then
        screen -dmS limxray watch -n 21600 limxray
    else
        screen -S limxray -p 0 -X quit
    fi
    unset PID_GEN
    PID_GEN=$(ps x | grep -v grep | grep "limxray")
    [[ ! $PID_GEN ]] && PID_GEN="\033[91m [ DESATIVADO ] " || PID_GEN="\033[92m [ ATIVADO ] "
    statgen="$(echo $PID_GEN)"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            REMOVER EXPIRADOS | UUID ${KEY^^}             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "                    $statgen "
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Função para mostrar conexões ativas
conexao() {
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\E[44;1;37m            CONEXÕES ATIVAS             \E[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    netstat -tunlp | grep ${KEY}
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "\033[1;37m• \033[1;33mEnter Para Continuar\033[1;31m" && read enter
    fun_xraymanager
}

# Menu principal
fun_xraymanager() {
    check_dependencies
    while true; do
        clear
        PID_GEN=$(ps x | grep -v grep | grep "limxray")
        [[ ! $PID_GEN ]] && PID_GEN="\033[91m [ DESATIVADO ] " || PID_GEN="\033[92m [ ATIVADO ] "
        statgen="$(echo $PID_GEN)"
        echo -e "\033[1;36m┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓\033[0m"
        echo -e "\033[1;36m┃\E[46;1;37m            GERENCIADOR ${KEY^^}            \E[0m\033[1;36m┃"
        echo -e "\033[1;36m┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫\033[0m"
        xcore_status=$(if netstat -tunlp | grep ${KEY} >/dev/null 2>&1; then echo -e "\033[92m ATIVADO"; else echo -e "\033[91m DESATIVADO"; fi)
        xcore_icon=$(if netstat -tunlp | grep ${KEY} >/dev/null 2>&1; then echo -e "\033[1;32m◉ "; else echo -e "\033[1;31m○ "; fi)
        echo -e "\033[1;36m┃\033[1;32mSERVIÇO: \033[1;33m${KEY^^} \033[1;32m$xcore_status \033[1;37m               \033[1;36m┃"
        echo -e "\033[1;36m┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫\033[0m"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m01\033[1;31m] \033[1;37m• \033[1;33mINSTALAR ${KEY^^} $xcore_icon                 \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m02\033[1;31m] \033[1;37m• \033[1;33mALTERAR PROTOCOLO                 \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m03\033[1;31m] \033[1;37m• \033[1;33mATIVAR TLS                        \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m04\033[1;31m] \033[1;37m• \033[1;33mEDITAR PORTA ${KEY^^}                \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m05\033[1;31m] \033[1;37m• \033[1;33mADICIONAR USUÁRIO UUID            \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m06\033[1;31m] \033[1;37m• \033[1;33mREMOVER USUÁRIO UUID              \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m07\033[1;31m] \033[1;37m• \033[1;33mMOSTRAR USUÁRIOS REGISTRADOS      \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m08\033[1;31m] \033[1;37m• \033[1;33mINFORMAÇÕES DA CONTA              \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m09\033[1;31m] \033[1;37m• \033[1;33mESTATÍSTICAS DE CONSUMO           \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m10\033[1;31m] \033[1;37m• \033[1;33mLIMITADOR POR CONSUMO             \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m11\033[1;31m] \033[1;37m• \033[1;33mREMOVER EXPIRADOS $statgen  \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m12\033[1;31m] \033[1;37m• \033[1;33mDESINSTALAR ${KEY^^}                 \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m13\033[1;31m] \033[1;37m• \033[1;33mCONEXÕES ATIVAS                   \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m14\033[1;31m] \033[1;37m• \033[1;33mVOLTAR \033[1;32m<\033[1;33m<\033[1;31m<                        \033[1;36m┃"
        echo -e "\033[1;36m┃\033[1;31m[\033[1;36m00\033[1;31m] \033[1;37m• \033[1;33mSAIR \033[1;32m<\033[1;33m<\033[1;31m<                          \033[1;36m┃"
        echo -e "\033[1;36m┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛\033[0m"
        tput civis
        echo -ne "\033[1;36m┗➤\033[1;32m ESCOLHA UMA OPÇÃO \033[1;32m?\033[1;37m: "
        read x
        tput cnorm
        clear
        case $x in
            1 | 01) install_core ;;
            2 | 02) protocol_core ;;
            3 | 03) tls_core ;;
            4 | 04) port_core ;;
            5 | 05) add_user ;;
            6 | 06) remove_user ;;
            7 | 07) show_users ;;
            8 | 08) info_account ;;
            9 | 09) stats_core ;;
            10) limit_port ;;
            11) clean_expired ;;
            12) uninstall_core ;;
            13) conexao ;;
            14) break ;;
            0 | 00)
                echo -e "\033[1;31mSaindo...\033[0m"
                sleep 1
                clear
                exit
                ;;
            *)
                echo -e "\033[1;31mOpção inválida!\033[0m"
                sleep 2
                ;;
        esac
    done
}

# Executar o menu
fun_xraymanager
